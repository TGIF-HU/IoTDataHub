<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Chart.jsを追加 -->
    <script>
        let rssiData = [];
        let rssiChart; // グローバル変数でチャートを管理

        function fetchValidDevices() {
            fetch('/valid_devices')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('deviceCount').innerText = data.valid_device_count;
                    updateLastUpdatedTime();
                })
                .catch(error => console.error('Error fetching valid device count:', error));
        }

        function fetchScannedDevices() {
            fetch('/scanned_devices')
                .then(response => response.json())
                .then(data => {
                    const deviceList = document.getElementById('deviceList');
                    deviceList.innerHTML = ''; // リストをクリア
                    rssiData = []; // RSSIデータをリセット

                    data.forEach(device => {
                        const listItem = document.createElement('li');

                        const manufactureIdStr = Array.isArray(device.manufacture_id)
                            ? device.manufacture_id.join(', ')
                            : device.manufacture_id;

                        const deviceName = device.name || '(no name)';

                        listItem.innerHTML = `
                            <strong>Address:</strong> ${device.address}<br>
                            <strong>RSSI:</strong> ${device.rssi}<br>
                            <strong>Device ID:</strong> ${device.device_id}<br>
                            <strong>Manufacture ID:</strong> ${manufactureIdStr}<br>
                            <strong>Name:</strong> ${deviceName}<br>
                            <strong>Time:</strong> ${device.time}
                        `;
                        deviceList.appendChild(listItem);

                        // RSSIデータを集める
                        rssiData.push(device.rssi);
                    });

                    updateLastUpdatedTime();
                    updateHistogram(); // ヒストグラムを更新
                    updateDeviceMap(); // デバイスの分布を更新
                })
                .catch(error => console.error('Error fetching scanned devices:', error));
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            const formattedTime = now.toLocaleString();
            document.getElementById('lastUpdated').innerText = formattedTime;
        }

        function initializeHistogram() {
            const ctx = document.getElementById('rssiChart').getContext('2d');
            rssiChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [], // 初期化時には空のラベル
                    datasets: [{
                        label: 'デバイス数',
                        data: [],
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'RSSI (dBm)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'デバイス数'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateHistogram() {
            const rssiRange = [-100, -90, -80, -70, -60, -50, -40, -30]; // RSSIの範囲を指定
            const counts = new Array(rssiRange.length).fill(0);

            // RSSIを範囲ごとにカウント
            rssiData.forEach(rssi => {
                for (let i = 0; i < rssiRange.length; i++) {
                    if (rssi < rssiRange[i]) {
                        counts[i]++;
                        break;
                    }
                }
            });

            // ヒストグラムのデータを更新
            rssiChart.data.labels = rssiRange.map((rssi, i) => `${rssi}dBm〜`);
            rssiChart.data.datasets[0].data = counts;
            rssiChart.update(); // チャートを再描画
        }

        function updateDeviceMap() {
            fetch('/get_device_positions')
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('mapCanvas').getContext('2d');
                    const mapContainer = document.getElementById('mapContainer');
                    const mapWidth = mapContainer.offsetWidth;
                    const mapHeight = mapContainer.offsetHeight;

                    ctx.clearRect(0, 0, mapWidth, mapHeight); // キャンバスをクリア

                    // 受信デバイスの描画
                    data.receivers.forEach(device => {
                        const x = device.position.x * mapWidth;
                        const y = device.position.y * mapHeight;
                        ctx.fillStyle = 'red';
                        ctx.beginPath();
                        ctx.arc(x, y, 10, 0, 2 * Math.PI);
                        ctx.fill();
                        ctx.fillText(device.device_id, x + 10, y);
                    });

                    // 送信デバイスの推定位置の描画
                    if (data.sender) {
                        const x = data.sender.position.x * mapWidth;
                        const y = data.sender.position.y * mapHeight;
                        ctx.fillStyle = 'blue';
                        ctx.beginPath();
                        ctx.arc(x, y, 10, 0, 2 * Math.PI);
                        ctx.fill();
                        ctx.fillText(data.sender.device_id, x + 10, y);
                    }
                })
                .catch(error => console.error('Error fetching device positions:', error));
        }

        window.onload = function () {
            initializeHistogram(); // ページ読み込み時にヒストグラムを初期化
            fetchValidDevices();
            fetchScannedDevices();
            setInterval(fetchValidDevices, 5000);
            setInterval(fetchScannedDevices, 5000); // 5秒ごとにデバイス情報とヒストグラムを更新
        };
    </script>
</head>

<body>
    <h1>Device Dashboard</h1>
    <p>直近5分間の有効デバイス数: <span id="deviceCount">0</span></p>

    <p>最終更新時刻: <span id="lastUpdated">未更新</span></p>

    <h2>RSSIヒストグラム</h2>
    <canvas id="rssiChart" width="400" height="200"></canvas> <!-- ヒストグラムを表示するキャンバス -->

    <h2>デバイスの分布</h2>
    <div id="mapContainer" style="position: relative; width: 600px; height: 400px;">
        <img src="/static/map_image.png" style="position: absolute; width: 100%; height: 100%;">
        <canvas id="mapCanvas" width="600" height="400" style="position: absolute;"></canvas>
    </div>

    <h2>30分以内にスキャンされたデバイス情報:</h2>
    <ul id="deviceList">
        <!-- デバイス情報はここに表示される -->
    </ul>
</body>

</html>
